/*! A Votes Statistic Tool for PS.  Ver: 1.0.0  Date: 2013/09/01 18:07:34 */
jQuery(function(t){var e=window.localStorage,o=20,a=100,i=211,n=18,l=12,r="__preVotes",s="__preVotes_bk",d="__votesHist",c=null,u=null,p=!1,m=!1,h={support:"恭喜！您的浏览器可以正确支持该投票统计工具，可放心使用！",noSupport:"很遗憾！您的浏览器缺乏一些特性，无法完全支持该统计工具，推荐您使用最新版本的Chrome浏览器！",clearData:"警告：您确定要清空所有投票结果么？该操作将删除之前所有的统计数据，将其清零，之前所有的努力都付之一炬了，请三思啊！",exportData:"请将以下数据导出结果复制出来，交给作者处理！",exportOkay:"数据导出成功！请查看页面底部输出结果.",revertAlert:"您确信要撤销前一次的统计数据么？",revertOkay:"撤销前一次的统计数据成功!",noRevertData:"没有可以撤销的操作!",aInvalid:"A 区块选票数目不足"+o+"票，该选票无效！",bInvalid:"B 区块选票数目不足"+o+"票，该选票无效！",invalid:"选票总数目超过"+a+"票，该选票无效！",success:"投票成功, 选票分别投给了：",clearAll:"所有数据已被清空！",clearCurr:"当前选票数据已被清空！",ratioError:"放大系数输入非法，请输入大于等于1的整数！",revertLabel:"撤销前一次统计",noDataToMerge:"没有可供合并的数据",noDataToImport:"没有可供导入的数据",importSuccess:"数据导入成功!",mergeSuccess:"数据合并成功!",dataFormatErr:"数据格式错误!",noData:"无数据"},f={init:function(){this.supportLocalStorage?f.showMsg(h.support):f.showMsg(h.noSupport),f.initHandler(),f.loadData(),"#zoom"!==window.location.hash&&t("div.zoom-div").hide(),"#merge"!==window.location.hash&&t("div.oparea a.merge").hide(),"#import"!==window.location.hash&&t("div.oparea a.import").hide()},initHandler:function(){var e=function(e,a){t("td",e).not("td.empty").on({click:function(){if(c=u,u=t(this).data("id"),t(this).toggleClass("selected"),m)for(var i=c;u>i;i++)t('table.table td[data-id="'+i+'"]').toggleClass("selected",!0);else if(p&&u>c)for(var l=c;u>l;l+=n)t('table.table td[data-id="'+l+'"]').toggleClass("selected",!0);var r=t("td.selected",e).length;t("td."+a,e).text(r),r>=o?t("td."+a,e).toggleClass("valid",!0):t("td."+a,e).toggleClass("valid",!1)}})};e(t("table.atable"),"acounter"),e(t("table.btable"),"bcounter"),t("a.help").on("click",function(){f.showHelp()}),t("a.okay").on("click",function(){f.checkBeforeSubmit()}),t("a.clear").on("click",function(){f.clearCurrent()}),t("a.merge").on("click",function(){f.showMerge()}),t("a.import").on("click",function(){f.showImport()}),t("a.export").on("click",function(){f.exportData()}),t("a.revert").on("click",function(){f.revertAlert()}),t("a.clearall").on("click",function(){f.clearAllAlert()}),t("a.merge-confirm").on("click",function(){f.mergeData()}),t("a.import-confirm").on("click",function(){f.importData()}),t("a.viewResult").on("click",function(){f.loadData(),window.location.hash="",window.location.hash="output",t("div.outcontent").hide().fadeIn()}),Mousetrap.bind(["shift"],function(){m=!0},"keypress"),Mousetrap.bind(["shift"],function(){m=!1},"keyup"),Mousetrap.bind(["alt","ctrl"],function(){p=!0},"keypress"),Mousetrap.bind(["alt","ctrl"],function(){p=!1},"keyup")},loadData:function(){var t=e.getItem(r);t=JSON.parse(t),f.updateData(t)},showImport:function(){t("h3, table","div.content").hide(),t("div.input-div").fadeIn(),t("a.import-confirm").show()},importData:function(){var o,a=t.trim(t("#data-area").val());if(!a)return f.showMsg(h.noDataToImport),void 0;try{o=JSON.parse(a)}catch(i){return f.showMsg(h.dataFormatErr),void 0}f.showMsg(h.importSuccess),e.setItem(r,JSON.stringify(o)),f.updateData(o)},showMerge:function(){t("h3, table","div.content").hide(),t("div.input-div").fadeIn(),t("a.merge-confirm").show()},mergeData:function(){var o,a=t.trim(t("#data-area").val());if(!a)return f.showMsg(h.noDataToMerge),void 0;try{o=JSON.parse(a)}catch(i){return f.showMsg(h.dataFormatErr),void 0}var n=e.getItem(r);if(n=JSON.parse(n),null==n)return f.showMsg(h.mergeSuccess),e.setItem(r,JSON.stringify(o)),f.updateData(o),void 0;if(n&&o){n.totalT+=o.totalT,n.validT+=o.validT,n.invalidT+=o.invalidT,n.totalV+=o.totalV;for(var l=0,s=o.data.length;s>l;l++)for(var d=0,c=n.data.length;c>d;d++)if(n.data[d].key===o.data[l].key){n.data[d].val+=o.data[l].val;break}e.setItem(r,JSON.stringify(n)),f.updateData(n)}},exportData:function(){var o=e.getItem(r);f.showMsg(h.exportOkay),t("div.output h5").hide(),null==o?t("div.outcontent").html(h.noData):t("div.outcontent").html(h.exportData+"<br/><br/>"+o),window.location.hash="",window.location.hash="output",t("div.outcontent").hide().fadeIn()},showHelp:function(){window.location.hash="",window.location.hash="help",t("div.help").hide().fadeIn()},clearCurrent:function(){t("table.atable td, table.btable td").removeClass("selected"),t("table td.count").text(0).removeClass("valid")},revertAlert:function(){f.showMsg(h.revertAlert),t("#msgbox").append('<a href="javascript:;" class="revertConfirm warning-btn">确认撤销</a>'),t("a.revertConfirm").on("click",function(){f.revertOne()})},revertOne:function(){t("a.revertConfirm").off("click");var o=e.getItem(r),a=e.getItem(d);if(null==o||null==a)return f.showMsg(h.noRevertData),void 0;if(o=JSON.parse(o),a=JSON.parse(a)||[],!(a.length>0))return f.showMsg(h.noRevertData),void 0;var i=a.pop();o.totalT-=i.totalT,o.validT-=i.validT,o.invalidT-=i.invalidT,o.totalV-=i.totalV;for(var n=0,l=i.data.length;l>n;n++)for(var s=0,c=o.data.length;c>s;s++)if(o.data[s].key===i.data[n].key){i.base?o.data[s].val-=1*i.base:o.data[s].val--;break}e.setItem(d,JSON.stringify(a)),e.setItem(r,JSON.stringify(o)),f.updateData(o),t("a.revert").text(h.revertLabel+"("+a.length+")"),f.showMsg(h.revertOkay)},clearAllAlert:function(){f.showMsg(h.clearData),t("#msgbox").append('<a href="javascript:;" class="clearallConfirm warning-btn">确认清除</a>'),t("a.clearallConfirm").on("click",function(){f.clearAll()})},clearAll:function(){e.setItem(s,e.getItem(r)),e.removeItem(r),e.removeItem(d),t("a.clearallConfirm").off("click"),f.updateData({totalT:0,validT:0,invalidT:0,totalV:0,data:f.getInitData()}),f.showMsg(h.clearAll)},showMsg:function(e){t("#msgbox").html(e),t("#msgbox").hide().fadeIn()},getInitData:function(){for(var t=[],e=0;i>=e;e++)t.push({key:e,val:0});return t},checkBeforeSubmit:function(){var e=+t("#zoom-ration").val();return 1===e?f.submitVotes():e>1?(t("#zoom-confirm em").text(e),t("#pop-cancel").off("click"),t("#pop-confirm").off("click"),t("#pop-cancel").on("click",function(){t.modal.close()}),t("#pop-confirm").on("click",function(){return t.modal.close(),f.submitVotes(),!1}),t.modal(t("#zoom-confirm"),{persist:!0,maxWidth:420,minHeight:160})):f.showMsg(h.ratioError),!1},submitVotes:function(){var i=!0,n=[],s=+t("#zoom-ration").val(),c=e.getItem(r),u=e.getItem(d),p=f.buildVoteData(),m=t("table.atable td.selected").length,v=t("table.btable td.selected").length;o>m&&n.push(h.aInvalid),o>v&&n.push(h.bInvalid),m+v>a&&n.push(h.invalid),n.length>0&&(i=!1,f.showMsg(n.join(",")));var g=i?1*s:0,b=i?0:1*s,w=i?p.length*s:0;if(null==c?c={totalT:1*s,validT:g,invalidT:b,totalV:w,base:s,data:f.getInitData()}:(c=JSON.parse(c),c.totalT+=1*s,c.validT+=g,c.invalidT+=b,c.totalV+=w),i){for(var y=[],x=0,I=p.length;I>x;x++){y.push(p[x].key);for(var k=0,C=c.data.length;C>k;k++)if(c.data[k].key===p[x].key){c.data[k].val+=1*s;break}}f.showMsg(h.success+y.join(","))}return u=JSON.parse(u)||[],u.length>=l&&u.shift(),i?u.push({totalT:1*s,validT:g,invalidT:b,totalV:w,base:s,data:p}):u.push({totalT:1*s,validT:g,invalidT:b,totalV:w,base:s,data:[]}),t("a.revert").text(h.revertLabel+"("+u.length+")"),e.setItem(d,JSON.stringify(u)),e.setItem(r,JSON.stringify(c)),f.updateData(c),f.clearCurrent(),t("#zoom-ration").val("1"),!1},updateData:function(o,a,i){a=!1,i=!1;var n=null,l=[],r=e.getItem(d);if(null==r?t("a.revert").text(h.revertLabel+"(0)"):(r=JSON.parse(r)||[],t("a.revert").text(h.revertLabel+"("+r.length+")")),null!=o){t("#counter td.t-votes").text(o.totalV),t("#counter td.t-tickets").text(o.totalT),t("#counter td.v-tickets").text(o.validT),t("#counter td.i-tickets").text(o.invalidT);for(var s,c=o.data,u=[],p=0,m=c.length;m>p;p++)s=t('table.table td[data-id="'+c[p].key+'"]'),s.find("em").text("("+c[p].val+")"),c[p].val>0&&u.push(c[p]);n=i?o.data:u.sort(function(t,e){return e.val-t.val});for(var f=0,v=n.length;v>f;f++)l[f]=a?"<tr><th>"+n[f].key+"</th><td>"+n[f].val+"</td></tr>":n[f].key+":"+n[f].val+"票";t("div.output h5").show(),a?t("div.outcontent").html("<table><th>编号</th><td>票数</td>"+l.join("")+"</table>"):(l.push("其它0票."),t("div.outcontent").html(l.join(",")))}},buildVoteData:function(){var e=[],o=t("table.table td.selected");return o.each(function(o,a){var i=t(a).data("id");e.push({key:i,val:1})}),e},supportLocalStorage:function(){var t,e,o=new Date;try{return(t=window.localStorage).setItem(o,o),e=""+t.getItem(o)==""+o,t.removeItem(o),!(!e||!t)}catch(a){}}()};f.init()});